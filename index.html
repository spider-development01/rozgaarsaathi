<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rozgaar Saathi | Find Work & Workers</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Remix Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- SDKs -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
                :root {
            --primary: #4E3BF7;      
            --primary-dark: #1c146a;
            --secondary: #7300ff;    
            --bg: #aab9b2;           
            --surface: #ffffff;
            --text-main: #24355a;
            --text-muted: #0d1f42;
            --border: #E5E7EB;
            --success: #046545;
            --danger: #EF4444;
            --shadow: 0 10px 40px -10px rgba(78, 59, 247, 0.1);
            --radius: 16px;
        }


        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Manrope', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.6;
            overscroll-behavior-y: none;
        }

        /* --- HEADER --- */
        header {
            background: var(--surface);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            height: 70px;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand span { color: var(--primary); }

        #logoutBtn {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            width: auto;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: 0.2s;
        }
        #logoutBtn:hover { background: #f3f4f6; color: var(--text-main); }

        /* --- MAIN CONTAINER --- */
        main {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            min-height: calc(100vh - 70px);
        }

        .view { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 { font-size: 1.8rem; font-weight: 800; margin: 0 0 0.5rem 0; line-height: 1.2; }
        h2 + p { color: var(--text-muted); margin-top: 0; margin-bottom: 2rem; }

        .hidden { display: none !important; }

        /* --- FORMS & INPUTS --- */
        .form-group { margin-bottom: 1.2rem; position: relative; }
        
        input, select, textarea {
            width: 100%;
            padding: 16px;
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-main);
            transition: all 0.2s;
            -webkit-appearance: none;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(78, 59, 247, 0.1);
        }

        input:required { border-left: 4px solid var(--primary); }

        /* Password Toggle */
        .password-wrapper { position: relative; }
        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            background: none;
            border: none;
            padding: 0;
        }

        /* --- BUTTONS & LOADERS --- */
        button.primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        button.primary-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        button.primary-btn:active { transform: translateY(0); }
        button.primary-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner-icon {
            animation: spin 1s linear infinite;
            font-size: 1.2rem;
        }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
            pointer-events: none;
        }
        .toast {
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.3s ease-out forwards;
            pointer-events: auto;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .toast.error { background: #FEF2F2; color: #B91C1C; border: 1px solid #FECACA; }
        .toast.success { background: #ECFDF5; color: #047857; border: 1px solid #A7F3D0; }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

        /* --- CARD COMPONENTS --- */
        .card-container { display: grid; gap: 1rem; margin-top: 1.5rem; }
        .role-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .role-card:hover { border-color: var(--primary); background: #F5F3FF; }
        .role-card i { font-size: 2.5rem; color: var(--text-muted); margin-bottom: 10px; display: block; }
        .role-card:hover i { color: var(--primary); }
        
        .worker-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 1.2rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .worker-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
        }

        .active-job-profile {
            background: #F0FDFA; 
            border: 2px solid var(--success);
            align-items: flex-start;
        }
        
        .phone-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--success);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 700;
            margin-top: 12px;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: 0.2s;
        }
        .phone-link:hover { background: #059669; transform: scale(1.05); }

        /* Auth Toggle */
        .auth-toggle {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.95rem;
        }
        .auth-toggle span {
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Mobile Optimizations */
        @media (max-width: 480px) {
            main { padding: 1.5rem 1rem; }
            h2 { font-size: 1.6rem; }
            .worker-card { flex-direction: column; text-align: center; }
            .phone-link { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Header -->
    <header>
        <div class="brand">
            <i class="ri-briefcase-4-fill" style="color:var(--primary);"></i>
            Rozgaar<span>Saathi</span>
        </div>
        <button id="logoutBtn" class="hidden" onclick="handleLogout()">
            <i class="ri-logout-box-r-line"></i> <span style="margin-left:4px">Logout</span>
        </button>
    </header>

    <main id="app">
        
        <!-- SCREEN 1: Role Selection -->
        <section id="role-selection" class="view">
            <h2>Who are you?</h2>
            <p>Select your role to get started.</p>
            <div class="card-container">
                <div onclick="selectRole('employer')" class="role-card">
                    <i class="ri-building-4-line"></i>
                    <h3>Employer</h3>
                    <span style="color:var(--text-muted)">I want to hire workers</span>
                </div>
                <div onclick="selectRole('worker')" class="role-card">
                    <i class="ri-hammer-line"></i>
                    <h3>Worker</h3>
                    <span style="color:var(--text-muted)">I am looking for jobs</span>
                </div>
            </div>
        </section>

        <!-- SCREEN 1.5: Language -->
        <section id="language-selection" class="view hidden">
            <h2>Select Language</h2>
            <div class="card-container">
                <button class="primary-btn" style="background:white; color:var(--text-main); border:1px solid var(--border); justify-content:space-between" onclick="setLanguage('en')">English <i class="ri-arrow-right-s-line"></i></button>
                <button class="primary-btn" style="background:white; color:var(--text-main); border:1px solid var(--border); justify-content:space-between" onclick="setLanguage('hi')">Hindi (हिंदी) <i class="ri-arrow-right-s-line"></i></button>
                <button class="primary-btn" style="background:white; color:var(--text-main); border:1px solid var(--border); justify-content:space-between" onclick="setLanguage('pb')">Punjabi (ਪੰਜਾਬੀ) <i class="ri-arrow-right-s-line"></i></button>
            </div>
        </section>

        <!-- SCREEN 2: Auth -->
        <section id="auth-screen" class="view hidden">
            <h2 id="auth-title">Welcome Back</h2>
            <p id="auth-subtitle">Enter your details to login.</p>
            
            <form id="auth-form">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="email" placeholder="name@example.com" autocomplete="email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" placeholder="Enter password" autocomplete="current-password" required>
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility()" aria-label="Toggle Password">
                            <i class="ri-eye-off-line" id="eye-icon"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="primary-btn" id="auth-btn">
                    <span>Login</span> <i class="ri-arrow-right-line"></i>
                </button>

                <div class="auth-toggle">
                    <p id="toggle-text">New here? <span onclick="toggleAuthMode()">Create an Account</span></p>
                </div>
            </form>
        </section>

        <!-- SCREEN 2.5: Verify Email (NEW) -->
        <section id="verify-email-screen" class="view hidden" style="text-align:center; padding-top:3rem;">
            <div style="background:#EFF6FF; width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem auto;">
                <i class="ri-mail-send-line" style="font-size:2.5rem; color:var(--primary);"></i>
            </div>
            <h2>Check your Inbox</h2>
            <p>We have sent a verification link to <br><strong id="sent-email" style="color:var(--text-main)"></strong></p>
            
            <!-- Loading Icon -->
            <div class="spinner-icon" style="color:var(--primary); font-size:2.5rem; margin:2rem 0;">
                <i class="ri-loader-4-line"></i>
            </div>

            <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:2rem;">
                Click the link in the email to verify your account and continue.
            </p>

            <button class="primary-btn" style="background:transparent; color:var(--text-muted); border:1px solid var(--border);" onclick="location.reload()">
                I have verified
            </button>
        </section>

        <!-- SCREEN 3: Profile Setup -->
        <section id="onboarding-screen" class="view hidden">
            <h2>Complete Profile</h2>
            <p>Just a few more details.</p>
            <form id="profile-form">
                <div class="form-group">
                    <label>Upload Photo</label>
                    <input type="file" id="profile-photo" accept="image/*" required>
                </div>
                
                <div id="worker-category-input" class="hidden form-group">
                    <label>Select Category</label>
                    <select id="category" required>
                        <option value="Labour">Labour Worker</option>
                        <option value="Carpenter">Carpenter</option>
                        <option value="Maid">Maid</option>
                        <option value="Cook">Cook</option>
                        <option value="Cleaner">Home Cleaner</option>
                        <option value="Electrician">Electrician</option>
                        <option value="Plumber">Plumber</option>
                    </select>
                </div>

                <div class="form-group"><input type="text" id="full-name" placeholder="Full Name" autocomplete="name" required></div>
                <div class="form-group"><input type="tel" id="phone" placeholder="Mobile Number" autocomplete="tel" required></div>
                
                <div class="form-group">
                    <select id="city" required>
                        <option value="" disabled selected>Select City</option>
                        <option value="New Delhi">New Delhi</option>
                        <option value="Ludhiana">Ludhiana</option>
                        <option value="Gurgaon">Gurgaon</option>
                        <option value="Mumbai">Mumbai</option>
                    </select>
                </div>
                <div class="form-group"><input type="text" id="address" placeholder="Full Address / Landmark" autocomplete="street-address" required></div>
                
                <button type="submit" class="primary-btn">Save Profile</button>
            </form>
        </section>

        <!-- SCREEN 4: Employer Search -->
        <section id="employer-dashboard" class="view hidden">
            <h2>Find Workers</h2>
            <div style="background:white; padding:1rem; border:1px solid var(--border); border-radius:12px; display:flex; gap:10px; margin-bottom:1.5rem;">
                <select id="search-category" style="border:none; background:#f8f9fc; padding:10px;">
                    <option value="Labour">Labour Worker</option>
                    <option value="Carpenter">Carpenter</option>
                    <option value="Maid">Maid</option>
                    <option value="Cook">Cook</option>
                    <option value="Cleaner">Cleaner</option>
                    <option value="Electrician">Electrician</option>
                    <option value="Plumber">Plumber</option>
                </select>
                <button class="primary-btn" style="width:auto; padding:0 1.5rem;" onclick="findWorkers()">
                    <i class="ri-search-line"></i>
                </button>
            </div>
            <div id="workers-list"></div>
        </section>

        <!-- SCREEN 5: Worker Dashboard -->
        <section id="worker-dashboard" class="view hidden">
            <h2>My Dashboard</h2>
            
            <div id="worker-waiting-card" class="role-card" style="cursor:default;">
                <span style="background:#FFF7ED; color:#C2410C; padding:5px 12px; border-radius:20px; font-size:0.8rem; font-weight:700;">WAITING</span>
                <p style="margin:15px 0; font-weight:600;">Looking for jobs nearby...</p>
                <div class="spinner-icon" style="color:var(--primary);"><i class="ri-loader-4-line"></i></div>
            </div>

            <div id="worker-active-job-card" class="hidden">
                <div class="toast success" style="margin:0 0 1rem 0; width:100%; justify-content:center;">
                    <i class="ri-checkbox-circle-fill"></i> You have been hired!
                </div>
                
                <div class="worker-card active-job-profile">
                    <img id="employer-photo" src="" alt="Emp">
                    <div style="flex:1">
                        <h3 id="employer-name" style="margin:0 0 5px 0;"></h3>
                        <p style="margin:0; font-size:0.9rem; color:var(--text-muted);">
                            <i class="ri-map-pin-fill" style="color:var(--primary);"></i> <span id="employer-address"></span>
                        </p>
                        <a id="employer-phone" href="#" class="phone-link"></a>
                    </div>
                </div>

                <div id="otp-entry-area" style="margin-top:1.5rem;">
                    <button class="primary-btn" onclick="showOtpInput(this)">I have arrived / Start Job</button>
                </div>
                
                <div id="worker-otp-form" class="hidden" style="margin-top:1.5rem; background:white; padding:1.5rem; border-radius:12px; border:1px solid var(--border);">
                    <h3 style="margin:0 0 1rem 0; font-size:1.1rem;">Enter OTP from Employer</h3>
                    <input type="number" id="job-otp-input" placeholder="123456" style="font-size:1.5rem; letter-spacing:5px; text-align:center; margin-bottom:1rem;">
                    <button class="primary-btn" onclick="verifyOtp()">Verify & Complete</button>
                </div>
            </div>
        </section>

        <!-- SCREEN 6: Job In Progress (Employer) -->
        <section id="employer-job-screen" class="view hidden">
            <h2>Job Active</h2>
            <p>Worker is on the way.</p>

            <div class="worker-card active-job-profile">
                <img id="job-worker-photo" src="" alt="Wkr">
                <div style="flex:1">
                    <h3 id="job-worker-name" style="margin:0;"></h3>
                    <p style="color:var(--success); font-size:0.9rem; font-weight:600; margin:4px 0;">• Hired</p>
                    <a id="job-worker-phone" href="#" class="phone-link"></a>
                </div>
            </div>
            
            <div style="background:#FFF7ED; border:2px dashed #FB923C; border-radius:12px; padding:1.5rem; text-align:center; margin-top:1.5rem;">
                <p style="margin:0; color:#9A3412; font-weight:600;">Share OTP after work is done:</p>
                <div id="generated-otp" style="font-size:2.5rem; font-weight:800; color:#C2410C; margin:10px 0; letter-spacing:4px;">------</div>
            </div>

            <div id="employer-completion-msg" class="hidden" style="margin-top:1.5rem; text-align:center;">
                <div class="toast success" style="width:100%; justify-content:center; margin-bottom:1rem;">
                    <i class="ri-check-double-line"></i> Work Completed!
                </div>
                <button class="primary-btn" onclick="location.reload()">Find Another Worker</button>
            </div>
        </section>

    </main>

    <!-- LOGIC -->
    <script>
        // --- SETUP ---
        const SUPABASE_URL = 'https://prjwnbctmwkrscdsmtkh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByanduYmN0bXdrcnNjZHNtdGtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MjkwMDksImV4cCI6MjA3OTIwNTAwOX0.28WSuMkPd76qUSjGMz5KkKx-8cGtx17-0PgLYj8DfGM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = {
            user: null,
            profile: null,
            role: localStorage.getItem('rozgaar_role'), 
            lang: localStorage.getItem('rozgaar_lang') || 'en',
            activeJob: null,
            searchResult: [],
            isLoginMode: true 
        };

        // --- UI HELPERS ---
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<i class="ri-${type === 'success' ? 'checkbox-circle' : 'error-warning'}-fill"></i> ${msg}`;
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        function setLoading(btn, isLoading, text = null) {
            if (isLoading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner-icon"><i class="ri-loader-4-line"></i></div> ${text || 'Processing...'}`;
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText;
            }
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('password');
            const icon = document.getElementById('eye-icon');
            if (input.type === "password") {
                input.type = "text";
                icon.className = "ri-eye-line";
            } else {
                input.type = "password";
                icon.className = "ri-eye-off-line";
            }
        }

        // --- APP FLOW ---
        window.onload = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) handleSession(session.user);
            else {
                localStorage.removeItem('rozgaar_role');
                showView('role-selection');
            }
        };

        function showView(id) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            const hideLogout = ['role-selection','auth-screen','language-selection', 'verify-email-screen'];
            document.getElementById('logoutBtn').classList.toggle('hidden', hideLogout.includes(id));
        }

        // --- ROLE & LANG ---
        async function selectRole(role) {
            state.role = role;
            localStorage.setItem('rozgaar_role', role);
            if (state.user) {
                // Prevent existing users from switching roles by just clicking back
                const { data: profile } = await supabase.from('profiles').select('role').eq('id', state.user.id).single();
                if(profile && profile.role !== role) {
                     alert(`You are registered as a ${profile.role}. Please login as a ${profile.role}.`);
                     location.reload();
                     return;
                }
                location.reload();
            } else {
                if (role === 'worker') showView('language-selection');
                else showView('auth-screen');
            }
        }

        function setLanguage(l) {
            state.lang = l;
            localStorage.setItem('rozgaar_lang', l);
            showView('auth-screen');
        }

        // --- AUTH LOGIC ---
        function toggleAuthMode() {
            state.isLoginMode = !state.isLoginMode;
            const title = document.getElementById('auth-title');
            const sub = document.getElementById('auth-subtitle');
            const btn = document.querySelector('#auth-btn span');
            const toggle = document.querySelector('#toggle-text');

            if (state.isLoginMode) {
                title.textContent = "Welcome Back";
                sub.textContent = "Enter details to login.";
                btn.textContent = "Login";
                toggle.innerHTML = `New here? <span onclick="toggleAuthMode()">Create an Account</span>`;
                document.getElementById('password').autocomplete = "current-password";
            } else {
                title.textContent = "Create Account";
                sub.textContent = "Join us to find work or workers.";
                btn.textContent = "Sign Up";
                toggle.innerHTML = `Already have an account? <span onclick="toggleAuthMode()">Login</span>`;
                document.getElementById('password').autocomplete = "new-password";
            }
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if(!email || !password) return;

            const btn = document.getElementById('auth-btn');
            setLoading(btn, true, state.isLoginMode ? "Logging in..." : "Creating Account...");

            try {
                if (state.isLoginMode) {
                    // LOGIN
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    handleSession(data.user);
                } else {
                    // SIGNUP
                    const { data, error } = await supabase.auth.signUp({
                        email, 
                        password,
                        options: { 
                            emailRedirectTo: 'https://rozgaar.codeinblack.tech/' 
                        }
                    });
                    if (error) throw error;
                    
                    // SUCCESS: Don't login yet. Show Verify Screen.
                    document.getElementById('sent-email').textContent = email;
                    showView('verify-email-screen');
                    setLoading(btn, false);
                }
            } catch (err) {
                showToast(err.message, 'error');
                setLoading(btn, false);
            }
        });

        // --- MAIN LOGIC ---
        async function handleSession(user) {
            state.user = user;
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();

            const selectedRole = localStorage.getItem('rozgaar_role');
            
            if (profile) {
                if (selectedRole && profile.role !== selectedRole) {
                    // Role Mismatch Detected
                    await supabase.auth.signOut();
                    showToast(`Wrong Account: You are a ${profile.role}, not a ${selectedRole}.`, 'error');
                    setTimeout(() => {
                        localStorage.removeItem('rozgaar_role');
                        window.location.reload();
                    }, 2000);
                    return; 
                }

                state.profile = profile;
                state.role = profile.role;
                localStorage.setItem('rozgaar_role', profile.role);

                if (state.role === 'employer') {
                    showView('employer-dashboard');
                    checkActiveJobsEmployer();
                } else {
                    showView('worker-dashboard');
                    listenForJobs();
                }
            } else {
                // No profile yet -> Onboarding
                showView('onboarding-screen');
                if(state.role === 'employer') {
                    document.getElementById('worker-category-input').classList.add('hidden');
                    document.getElementById('category').removeAttribute('required');
                } else {
                    document.getElementById('worker-category-input').classList.remove('hidden');
                    document.getElementById('category').setAttribute('required', 'true');
                }
            }
        }

        async function handleLogout() {
            if(confirm("Log out of Rozgaar Saathi?")) {
                await supabase.auth.signOut();
                localStorage.clear();
                location.reload();
            }
        }

        // --- PROFILE SAVE ---
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            setLoading(btn, true, "Saving...");

            const file = document.getElementById('profile-photo').files[0];
            let publicUrl = "https://via.placeholder.com/150";

            try {
                if (file) {
                    const fileName = `${Date.now()}-${file.name}`;
                    await supabase.storage.from('avatars').upload(fileName, file);
                    const res = supabase.storage.from('avatars').getPublicUrl(fileName);
                    publicUrl = res.data.publicUrl;
                }

                const role = state.role || localStorage.getItem('rozgaar_role');
                const payload = {
                    id: state.user.id,
                    role: role,
                    full_name: document.getElementById('full-name').value,
                    phone: document.getElementById('phone').value,
                    city: document.getElementById('city').value,
                    address: document.getElementById('address').value,
                    photo_url: publicUrl,
                    category: role === 'worker' ? document.getElementById('category').value : null,
                    language: state.lang
                };

                const { error } = await supabase.from('profiles').insert(payload);
                if (error) throw error;
                location.reload();
            } catch(err) {
                showToast(err.message, 'error');
                setLoading(btn, false);
            }
        });

        // --- EMPLOYER FEATURES ---
        async function findWorkers() {
            const cat = document.getElementById('search-category').value;
            const btn = document.querySelector('#employer-dashboard button');
            setLoading(btn, true, "");

            const { data } = await supabase.from('profiles').select('*').eq('role', 'worker').eq('category', cat);
            state.searchResult = data || [];
            
            const list = document.getElementById('workers-list');
            list.innerHTML = '';
            setLoading(btn, false);

            if (!data || !data.length) {
                list.innerHTML = `<div style="text-align:center; margin-top:2rem; color:var(--text-muted)"><i class="ri-ghost-smile-line" style="font-size:2rem"></i><p>No workers found nearby.</p></div>`;
                return;
            }

            data.forEach(w => {
                const img = (w.photo_url && !w.photo_url.includes('placeholder')) ? w.photo_url : 'https://via.placeholder.com/150';
                list.innerHTML += `
                    <div class="worker-card">
                        <img src="${img}">
                        <div style="flex:1">
                            <h3 style="margin:0; font-size:1.1rem;">${w.full_name}</h3>
                            <p style="margin:0; font-size:0.9rem; color:var(--text-muted);"><i class="ri-map-pin-line"></i> ${w.city}</p>
                        </div>
                        <button class="primary-btn" style="width:auto; padding:10px 20px; font-size:0.9rem;" onclick="initiateHire('${w.id}')">Hire ₹20</button>
                    </div>
                `;
            });
        }

        async function initiateHire(wid) {
            const worker = state.searchResult.find(w => w.id === wid);
            const btn = document.activeElement;
            setLoading(btn, true, "Wait...");

            try {
                const res = await fetch("https://razorpay-snll.onrender.com/create-order", { method: "POST", headers: {"Content-Type":"application/json"} });
                if (!res.ok) throw new Error("Payment server offline");
                const order = await res.json();

                const options = {
                    "key": "rzp_live_Rh4kTjb6HHV09d", 
                    "amount": order.amount, 
                    "currency": order.currency,
                    "name": "Rozgaar Saathi",
                    "description": "Hiring " + worker.full_name,
                    "order_id": order.id,
                    "handler": function (response) { createJob(worker); },
                    "prefill": { "name": state.profile.full_name, "contact": state.profile.phone },
                    "theme": { "color": "#4E3BF7" },
                    "modal": { "ondismiss": function() { setLoading(btn, false); } }
                };
                new Razorpay(options).open();
            } catch(err) {
                showToast(err.message, 'error');
                setLoading(btn, false);
            }
        }

        async function createJob(worker) {
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            await supabase.from('jobs').insert({ employer_id: state.user.id, worker_id: worker.id, otp: otp, status: 'hired' });
            showJobScreen(otp, worker);
        }

        function showJobScreen(otp, worker) {
            showView('employer-job-screen');
            document.getElementById('generated-otp').textContent = otp;
            document.getElementById('job-worker-name').textContent = worker.full_name;
            
            const link = document.getElementById('job-worker-phone');
            link.href = `tel:${worker.phone}`;
            link.innerHTML = `<i class="ri-phone-fill"></i> Call: ${worker.phone}`;
            
            const img = document.getElementById('job-worker-photo');
            img.src = (worker.photo_url && !worker.photo_url.includes('placeholder')) ? worker.photo_url : 'https://via.placeholder.com/150';

            const channel = supabase.channel('job-track').on('postgres_changes', 
                { event: 'UPDATE', schema: 'public', table: 'jobs', filter: `employer_id=eq.${state.user.id}` }, 
                (payload) => {
                    if (payload.new.status === 'completed') {
                        document.getElementById('employer-completion-msg').classList.remove('hidden');
                        supabase.removeChannel(channel);
                    }
                }
            ).subscribe();
        }

        async function checkActiveJobsEmployer() {
            const { data } = await supabase.from('jobs').select('*, profiles:worker_id(*)').eq('employer_id', state.user.id).eq('status', 'hired').single();
            if(data) showJobScreen(data.otp, data.profiles);
        }

        // --- WORKER FEATURES ---
        async function listenForJobs() {
            const check = async () => {
                const { data } = await supabase.from('jobs').select('*, profiles:employer_id(*)').eq('worker_id', state.user.id).eq('status', 'hired').single();
                if (data) {
                    state.activeJob = data;
                    const emp = data.profiles;
                    
                    document.getElementById('worker-waiting-card').classList.add('hidden');
                    document.getElementById('worker-active-job-card').classList.remove('hidden');

                    document.getElementById('employer-name').textContent = emp.full_name;
                    document.getElementById('employer-address').textContent = emp.address;
                    
                    const link = document.getElementById('employer-phone');
                    link.href = `tel:${emp.phone}`;
                    link.innerHTML = `<i class="ri-phone-fill"></i> Call: ${emp.phone}`;

                    const img = document.getElementById('employer-photo');
                    img.src = (emp.photo_url && !emp.photo_url.includes('placeholder')) ? emp.photo_url : 'https://via.placeholder.com/150';
                }
            };
            check();
            supabase.channel('worker-listen').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'jobs', filter: `worker_id=eq.${state.user.id}` }, check).subscribe();
        }

        function showOtpInput(btn) {
            btn.classList.add('hidden');
            document.getElementById('worker-otp-form').classList.remove('hidden');
        }

        async function verifyOtp() {
            const input = document.getElementById('job-otp-input');
            const btn = document.querySelector('#worker-otp-form button');
            setLoading(btn, true, "Verifying...");

            if (input.value == state.activeJob.otp) {
                await supabase.from('jobs').update({ status: 'completed' }).eq('id', state.activeJob.id);
                showToast("Job Completed Successfully!", 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast("Incorrect OTP. Try again.", 'error');
                setLoading(btn, false);
            }
        }
        // When the page loads, immediately wake it up
fetch("https://razorpay-snll.onrender.com");

// Keep sending pings every 3 minutes while the user is on the site
setInterval(() => {
  fetch("https://razorpay-snll.onrender.com");
}, 180000); // 180000 ms = 3 minutes

    </script>
</body>
</html>
