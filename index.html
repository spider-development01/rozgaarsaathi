<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rozgaar Saathi | Find Work & Workers</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Remix Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- SDKs -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #4E3BF7;      
            --primary-dark: #3a2db8;
            --secondary: #7300ff;    
            --bg: #aab9b2;           
            --surface: #e0e0e0;
            --text-main: #24355a;
            --text-muted: #0d1f42;
            --border: #E5E7EB;
            --success: #046545;
            --shadow: 0 10px 40px -10px rgba(78, 59, 247, 0.1);
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Manrope', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.6;
        }

        /* --- HEADER --- */
        header {
            background: var(--surface);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .brand span { color: var(--primary); }

        #logoutBtn {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            width: auto;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #logoutBtn:hover { background: #f3f4f6; color: var(--text-main); }

        /* --- MAIN CONTAINER --- */
        main {
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            min-height: 80vh;
        }

        .view { animation: fadeIn 0.4s ease-out forwards; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        h2 + p { color: var(--text-muted); margin-top: 0; margin-bottom: 2rem; }

        .hidden { display: none !important; }

        /* --- COMPONENTS --- */
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-main);
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(78, 59, 247, 0.1);
        }

        button.primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: transform 0.1s, background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        button.primary-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        button.primary-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .card-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .role-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .role-card:hover { border-color: var(--primary); box-shadow: var(--shadow); transform: translateY(-4px); }
        .role-card i { font-size: 3rem; color: var(--text-muted); margin-bottom:10px; display:block; }
        .role-card:hover i { color: var(--primary); }
        .role-card.worker:hover { border-color: var(--secondary); }
        .role-card.worker:hover i { color: var(--secondary); }

        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        .lang-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 1rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .lang-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* WORKER & PROFILE CARDS */
        .worker-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: transform 0.2s;
        }
        .worker-card img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border);
        }
        .worker-info { flex: 1; }
        .worker-info h3 { margin: 0 0 4px 0; font-size: 1.1rem; }
        .worker-info p { margin: 0; color: var(--text-muted); font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }

        .active-job-profile {
            border: 2px solid var(--primary);
            background: #F5F3FF;
            margin-bottom: 2rem;
            align-items: flex-start; 
        }

        .phone-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--success);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            margin-top: 12px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .phone-link:hover { background: #059669; }

        .status-card {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            margin-bottom: 2rem;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-waiting { background: #FEF3C7; color: #D97706; }

        .alert-box {
            background: #ECFDF5;
            border: 1px solid #10B981;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Mobile Tweaks */
        @media (max-width: 480px) {
            .worker-card { flex-direction: column; text-align: center; padding: 1rem; }
            .worker-card img { width: 80px; height: 80px; margin-bottom: 0.5rem; }
            .hire-btn { width: 100%; margin-top: 10px; }
            .active-job-profile { align-items: center; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="brand">
            <i class="ri-briefcase-4-fill" style="color:var(--primary);"></i>
            Rozgaar<span>Saathi</span>
        </div>
        <button id="logoutBtn" class="hidden" onclick="handleLogout()">
            <i class="ri-logout-box-r-line"></i> Logout
        </button>
    </header>

    <!-- Main Container -->
    <main id="app">
        
        <!-- SCREEN 1: Role Selection -->
        <section id="role-selection" class="view">
            <h2>Welcome! <br>How do you want to use the app?</h2>
            <p>Choose your role to get started.</p>
            <div class="card-container">
                <div onclick="selectRole('employer')" class="role-card">
                    <i class="ri-building-4-line"></i>
                    <h3>Employer</h3>
                    <span>I want to hire workers</span>
                </div>
                <div onclick="selectRole('worker')" class="role-card worker">
                    <i class="ri-hammer-line"></i>
                    <h3>Worker</h3>
                    <span>I am looking for jobs</span>
                </div>
            </div>
        </section>

        <!-- SCREEN 1.5: Language Selection -->
        <section id="language-selection" class="view hidden">
            <h2>Select Language</h2>
            <p>Please choose your preferred language.</p>
            <div class="btn-group">
                <button class="lang-btn" onclick="setLanguage('en')">English <i class="ri-arrow-right-s-line"></i></button>
                <button class="lang-btn" onclick="setLanguage('hi')">Hindi (हिंदी) <i class="ri-arrow-right-s-line"></i></button>
                <button class="lang-btn" onclick="setLanguage('pb')">Punjabi (ਪੰਜਾਬੀ) <i class="ri-arrow-right-s-line"></i></button>
            </div>
        </section>

        <!-- SCREEN 2: Auth -->
        <section id="auth-screen" class="view hidden">
            <h2 data-i18n="login_title">Login or Signup</h2>
            <p>Enter your details to continue.</p>
            <form id="auth-form">
                <div class="form-group"><input type="email" id="email" placeholder="Email Address" required></div>
                <div class="form-group"><input type="password" id="password" placeholder="Password" required></div>
                <button type="submit" class="primary-btn" data-i18n="continue_btn">Continue</button>
            </form>
        </section>

        <!-- SCREEN 3: Profile Onboarding -->
        <section id="onboarding-screen" class="view hidden">
            <h2 data-i18n="complete_profile">Setup Profile</h2>
            <p>Tell us a bit about yourself.</p>
            <form id="profile-form">
                <div class="form-group">
                    <label data-i18n="upload_photo">Profile Photo</label>
                    <input type="file" id="profile-photo" accept="image/*" required>
                </div>
                
                <div id="worker-category-input" class="hidden form-group">
                    <label data-i18n="select_category">Job Category</label>
                    <select id="category">
                        <option value="Labour">Labour Worker</option>
                        <option value="Carpenter">Carpenter</option>
                        <option value="Maid">Maid</option>
                        <option value="Cook">Cook</option>
                        <option value="Cleaner">Home Cleaner</option>
                        <option value="Electrician">Electrician</option>
                        <option value="Plumber">Plumber</option>
                    </select>
                </div>

                <div class="form-group"><input type="text" id="full-name" placeholder="Full Name" required></div>
                <div class="form-group"><input type="tel" id="phone" placeholder="Phone Number" required></div>
                
                <div class="form-group">
                    <select id="state">
                        <option value="" disabled selected>Select State</option>
                        <option value="Delhi">Delhi</option>
                        <option value="Punjab">Punjab</option>
                        <option value="Haryana">Haryana</option>
                        <option value="Maharashtra">Maharashtra</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="city">
                        <option value="" disabled selected>Select City</option>
                        <option value="New Delhi">New Delhi</option>
                        <option value="Ludhiana">Ludhiana</option>
                        <option value="Gurgaon">Gurgaon</option>
                        <option value="Mumbai">Mumbai</option>
                    </select>
                </div>
                <div class="form-group"><textarea id="address" rows="3" placeholder="Full Address" required></textarea></div>
                <button type="submit" class="primary-btn" data-i18n="save_profile">Save Profile</button>
            </form>
        </section>

        <!-- SCREEN 4: Employer Dashboard -->
        <section id="employer-dashboard" class="view hidden">
            <h2>Find a Worker</h2>
            <p>Search and hire verified workers near you.</p>
            <div class="search-bar" style="background:var(--surface); padding:1rem; border-radius:var(--radius); box-shadow:var(--shadow); display:flex; gap:10px; margin-bottom:2rem;">
                <select id="search-category" style="flex:1; margin:0; border:none; background:#F3F4F6;">
                    <option value="Labour">Labour Worker</option>
                    <option value="Carpenter">Carpenter</option>
                    <option value="Maid">Maid</option>
                    <option value="Cook">Cook</option>
                    <option value="Cleaner">Home Cleaner</option>
                    <option value="Electrician">Electrician</option>
                    <option value="Plumber">Plumber</option>
                </select>
                <button class="primary-btn" onclick="findWorkers()" style="width:auto; padding:0 2rem; margin:0;"><i class="ri-search-line"></i> Search</button>
            </div>
            <div id="workers-list" class="list-container"></div>
        </section>

        <!-- SCREEN 5: Worker Dashboard -->
        <section id="worker-dashboard" class="view hidden">
            <h2 data-i18n="dashboard_title">My Dashboard</h2>
            
            <!-- State A: Waiting for Job -->
            <div id="worker-waiting-card" class="status-card">
                <span class="status-badge status-waiting" data-i18n="status_label">Waiting</span>
                <p style="margin-top:10px; font-weight:600; font-size:1.2rem;" data-i18n="waiting_msg">Waiting for new jobs...</p>
                <div class="spinner" style="font-size:2rem; color:var(--primary); margin-top:10px;">
                    <i class="ri-loader-4-line" style="animation:spin 1s linear infinite; display:inline-block;"></i>
                </div>
            </div>

            <!-- State B: Active Job Found -->
            <div id="worker-active-job-card" class="hidden">
                <div class="alert-box">
                    <i class="ri-checkbox-circle-fill" style="font-size:2rem; color:var(--success);"></i>
                    <h3 style="margin:5px 0;" data-i18n="new_job">You have been hired!</h3>
                </div>

                <p>Employer Details:</p>
                <!-- Employer Profile Card -->
                <div class="worker-card active-job-profile">
                    <img id="employer-photo" src="" alt="Employer">
                    <div class="worker-info">
                        <h3 id="employer-name" style="font-size:1.3rem;"></h3>
                        <p style="margin-bottom:8px; color:var(--text-main); line-height:1.4;">
                            <i class="ri-map-pin-fill" style="color:var(--primary); margin-right:5px;"></i> 
                            <span id="employer-address"></span>
                        </p>
                        <a id="employer-phone" href="" class="phone-link">
                            <i class="ri-phone-fill"></i> Call Employer
                        </a>
                    </div>
                </div>
                
                <div id="start-job-btn-container">
                    <button class="primary-btn" onclick="acceptJob()" data-i18n="start_job">Start Job / Enter OTP</button>
                </div>

                <!-- OTP Entry for Worker -->
                <div id="worker-otp-section" class="hidden" style="margin-top:2rem; background:var(--surface); padding:1.5rem; border-radius:var(--radius); border:1px solid var(--border);">
                    <h3 data-i18n="enter_otp">Ask Employer for OTP</h3>
                    <div class="form-group">
                        <input type="text" id="job-otp-input" placeholder="6-digit OTP" maxlength="6" style="font-size:1.5rem; letter-spacing:5px; text-align:center;">
                    </div>
                    <button class="primary-btn" onclick="verifyOtp()" data-i18n="verify_otp">Verify & Complete Job</button>
                </div>
            </div>
        </section>

        <!-- SCREEN 6: Employer Job Active -->
        <section id="employer-job-screen" class="view hidden">
            <h2>Job in Progress</h2>
            <p>You have hired this worker:</p>

            <div class="worker-card active-job-profile">
                <img id="job-worker-photo" src="" alt="Worker">
                <div class="worker-info">
                    <h3 id="job-worker-name" style="font-size:1.4rem;"></h3>
                    <p style="margin-bottom:10px;"><i class="ri-map-pin-line"></i> On the way</p>
                    <a id="job-worker-phone" href="" class="phone-link">
                        <i class="ri-phone-fill"></i> <span id="job-worker-phone-text"></span>
                    </a>
                </div>
            </div>
            
            <div class="status-card">
                <p>Share this OTP with the worker when the job is done:</p>
                <div class="otp-display" id="generated-otp" style="background:#FFF7ED; color:#C2410C; font-size:3rem; font-weight:800; letter-spacing:5px; padding:1rem; border-radius:10px; border:2px dashed #FB923C; margin:1rem 0;">------</div>
                <p style="font-size:0.85rem; color:var(--text-muted);">Do not share until work is completed.</p>
            </div>

            <div id="employer-completion-msg" class="hidden alert-box">
                <i class="ri-check-double-line" style="font-size:2rem; color:var(--success);"></i>
                <h3>Job Completed Successfully!</h3>
                <button class="primary-btn" onclick="location.reload()">Hire Another</button>
            </div>
        </section>

    </main>

    <!-- SCRIPT -->
    <script>
        const SUPABASE_URL = 'https://prjwnbctmwkrscdsmtkh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByanduYmN0bXdrcnNjZHNtdGtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MjkwMDksImV4cCI6MjA3OTIwNTAwOX0.28WSuMkPd76qUSjGMz5KkKx-8cGtx17-0PgLYj8DfGM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = {
            user: null,
            profile: null,
            role: localStorage.getItem('rozgaar_role'), 
            lang: localStorage.getItem('rozgaar_lang') || 'en',
            activeJob: null,
            searchResult: []
        };

        const i18n = {
            en: { login_title: "Login or Signup", continue_btn: "Continue", complete_profile: "Complete Your Profile", upload_photo: "Upload Photo:", select_category: "Job Category:", save_profile: "Save Profile", dashboard_title: "My Dashboard", status_label: "Status:", waiting_msg: "Waiting for jobs...", new_job: "You have been hired!", start_job: "Start Job / Enter OTP", enter_otp: "Ask Employer for OTP", verify_otp: "Verify & Complete" },
            hi: { login_title: "लॉगिन / साइनअप", continue_btn: "जारी रखें", complete_profile: "प्रोफ़ाइल पूरी करें", upload_photo: "फोटो अपलोड करें:", select_category: "काम की श्रेणी:", save_profile: "सहेजें", dashboard_title: "डैशबोर्ड", status_label: "स्थिति:", waiting_msg: "काम का इंतज़ार...", new_job: "आपको काम मिला है!", start_job: "काम शुरू करें", enter_otp: "OTP पूछें", verify_otp: "सत्यापित करें" },
            pb: { login_title: "ਲੌਗਇਨ / ਸਾਈਨ ਅਪ", continue_btn: "ਜਾਰੀ ਰੱਖੋ", complete_profile: "ਪ੍ਰੋਫਾਈਲ ਪੂਰੀ ਕਰੋ", upload_photo: "ਫੋਟੋ:", select_category: "ਸ਼੍ਰੇਣੀ:", save_profile: "ਸੇਵ ਕਰੋ", dashboard_title: "ਡੈਸ਼ਬੋਰਡ", status_label: "ਸਥਿਤੀ:", waiting_msg: "ਉਡੀਕ ਕਰ ਰਿਹਾ ਹੈ...", new_job: "ਤੁਹਾਨੂੰ ਕੰਮ ਮਿਲਿਆ ਹੈ!", start_job: "ਸ਼ੁਰੂ ਕਰੋ", enter_otp: "OTP ਪੁੱਛੋ", verify_otp: "ਪੁਸ਼ਟੀ ਕਰੋ" }
        };

        window.onload = async () => {
            const style = document.createElement('style');
            style.innerHTML = `@keyframes spin { 100% { transform: rotate(360deg); } }`;
            document.head.appendChild(style);

            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                handleSession(session.user);
            } else {
                localStorage.removeItem('rozgaar_role');
                showView('role-selection');
            }
        };

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            applyTranslations();
            
            const logoutBtn = document.getElementById('logoutBtn');
            if(viewId === 'role-selection' || viewId === 'auth-screen' || viewId === 'language-selection') {
                logoutBtn.classList.add('hidden');
            } else {
                logoutBtn.classList.remove('hidden');
            }
        }

        async function selectRole(role) {
            state.role = role;
            localStorage.setItem('rozgaar_role', role);
            if (state.user) {
                await supabase.from('profiles').update({ role: role }).eq('id', state.user.id);
                location.reload();
                return;
            }
            if (role === 'worker') showView('language-selection');
            else showView('auth-screen');
        }

        function setLanguage(lang) {
            state.lang = lang;
            localStorage.setItem('rozgaar_lang', lang);
            showView('auth-screen');
        }

        function applyTranslations() {
            const lang = (state.role === 'employer') ? 'en' : state.lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) el.textContent = i18n[lang][key];
            });
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ri-loader-4-line"></i> Processing...';
            btn.disabled = true;

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                let { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    let signUp = await supabase.auth.signUp({ email, password });
                    if (signUp.error) throw signUp.error;
                    data = signUp.data;
                    alert("Account created!");
                }
                handleSession(data.user);
            } catch(err) {
                alert(err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        async function handleSession(user) {
            state.user = user;
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();

            if (profile) {
                if (!profile.role) {
                    alert("Profile missing role.");
                    showView('role-selection');
                    return;
                }
                state.profile = profile;
                state.role = profile.role; 
                localStorage.setItem('rozgaar_role', profile.role); 

                if (state.role === 'employer') {
                    showView('employer-dashboard');
                    checkActiveJobsEmployer();
                } else {
                    state.lang = profile.language || 'en';
                    showView('worker-dashboard');
                    listenForJobs();
                }
            } else {
                showView('onboarding-screen');
                if (state.role === 'employer') document.getElementById('worker-category-input').classList.add('hidden');
                else document.getElementById('worker-category-input').classList.remove('hidden');
            }
        }

        async function handleLogout() {
            if(confirm("Logout?")) {
                await supabase.auth.signOut();
                localStorage.clear();
                location.reload();
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerHTML = "Saving...";
            btn.disabled = true;
            const file = document.getElementById('profile-photo').files[0];
            let publicUrl = "https://via.placeholder.com/150";
            try {
                if (file) {
                    const fileName = `${Date.now()}-${file.name}`;
                    await supabase.storage.from('avatars').upload(fileName, file);
                    const res = supabase.storage.from('avatars').getPublicUrl(fileName);
                    publicUrl = res.data.publicUrl;
                }
                const roleToSave = state.role || localStorage.getItem('rozgaar_role');
                await supabase.from('profiles').insert({
                    id: state.user.id,
                    role: roleToSave,
                    full_name: document.getElementById('full-name').value,
                    phone: document.getElementById('phone').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    address: document.getElementById('address').value,
                    photo_url: publicUrl,
                    category: roleToSave === 'worker' ? document.getElementById('category').value : null,
                    language: state.lang
                });
                location.reload();
            } catch(err) {
                alert(err.message);
                btn.innerHTML = "Save Profile";
                btn.disabled = false;
            }
        });

        async function findWorkers() {
            const cat = document.getElementById('search-category').value;
            const btn = document.querySelector('.search-bar button');
            btn.innerHTML = '<i class="ri-loader-4-line"></i> Searching...';
            
            const { data: workers } = await supabase.from('profiles').select('*').eq('role', 'worker').eq('category', cat);
            state.searchResult = workers || [];

            const list = document.getElementById('workers-list');
            list.innerHTML = '';
            btn.innerHTML = '<i class="ri-search-line"></i> Search';

            if (!workers || !workers.length) { 
                list.innerHTML = `<div style="text-align:center; color:var(--text-muted); margin-top:2rem;"><i class="ri-ghost-line" style="font-size:3rem;"></i><p>No ${cat}s found.</p></div>`; 
                return; 
            }
            workers.forEach(w => {
                const imgUrl = w.photo_url.includes('placeholder') ? 'https://via.placeholder.com/150' : w.photo_url;
                list.innerHTML += `<div class="worker-card"><img src="${imgUrl}"><div class="worker-info"><h3>${w.full_name}</h3><p><i class="ri-map-pin-line"></i> ${w.city}</p></div><button class="hire-btn" onclick="initiateHire('${w.id}')">Hire ₹20</button></div>`;
            });
        }

        async function initiateHire(workerId) {
            const worker = state.searchResult.find(w => w.id === workerId);
            const hireBtn = document.activeElement;
            const originalText = hireBtn.textContent;
            hireBtn.textContent = "Processing...";
            hireBtn.disabled = true;

            try {
                const response = await fetch("https://razorpay-snll.onrender.com/create-order", { method: "POST", headers: { "Content-Type": "application/json" } });
                const orderData = await response.json();
                const options = {
                    "key": "rzp_live_Rh4kTjb6HHV09d", 
                    "amount": orderData.amount, 
                    "currency": orderData.currency,
                    "name": "Rozgaar Saathi",
                    "description": "Hiring " + worker.full_name,
                    "order_id": orderData.id,
                    "handler": function (response) { createJob(worker); },
                    "prefill": { "name": state.profile.full_name, "contact": state.profile.phone },
                    "theme": { "color": "#4E3BF7" },
                    "modal": { "ondismiss": function() { hireBtn.textContent = originalText; hireBtn.disabled = false; } }
                };
                const rzp1 = new Razorpay(options);
                rzp1.open();
            } catch (err) {
                alert("Error: Check backend.");
                hireBtn.textContent = originalText;
                hireBtn.disabled = false;
            }
        }

        async function createJob(workerObj) {
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            await supabase.from('jobs').insert({ employer_id: state.user.id, worker_id: workerObj.id, otp: otp, status: 'hired' });
            showJobScreen(otp, workerObj);
        }

        function showJobScreen(otp, workerObj) {
            showView('employer-job-screen');
            document.getElementById('generated-otp').textContent = otp;
            document.getElementById('job-worker-name').textContent = workerObj.full_name;
            document.getElementById('job-worker-phone').href = "tel:" + workerObj.phone;
            document.getElementById('job-worker-phone-text').textContent = workerObj.phone;
            document.getElementById('job-worker-photo').src = (workerObj.photo_url && !workerObj.photo_url.includes('placeholder')) ? workerObj.photo_url : 'https://via.placeholder.com/150';
            
            const channel = supabase.channel('job-track').on('postgres_changes', 
                { event: 'UPDATE', schema: 'public', table: 'jobs', filter: `employer_id=eq.${state.user.id}` }, 
                (payload) => {
                    if (payload.new.status === 'completed') {
                        document.getElementById('employer-completion-msg').classList.remove('hidden');
                        supabase.removeChannel(channel);
                    }
                }
            ).subscribe();
        }

        async function checkActiveJobsEmployer() {
            const { data } = await supabase.from('jobs').select('*, profiles:worker_id(*)').eq('employer_id', state.user.id).eq('status', 'hired').single();
            if (data) showJobScreen(data.otp, data.profiles);
        }

        async function listenForJobs() {
            const check = async () => {
                const { data } = await supabase.from('jobs').select('*, profiles:employer_id(*)').eq('worker_id', state.user.id).eq('status', 'hired').single();
                if (data) {
                    state.activeJob = data;
                    const emp = data.profiles;
                    
                    // 1. Hide Waiting Card
                    document.getElementById('worker-waiting-card').classList.add('hidden');
                    
                    // 2. Show Active Job Card
                    const activeCard = document.getElementById('worker-active-job-card');
                    activeCard.classList.remove('hidden');

                    // 3. Populate Data
                    document.getElementById('employer-name').textContent = emp.full_name;
                    document.getElementById('employer-address').textContent = emp.address;
                    document.getElementById('employer-phone').href = "tel:" + emp.phone;
                    
                    const img = document.getElementById('employer-photo');
                    img.src = (emp.photo_url && !emp.photo_url.includes('placeholder')) 
                              ? emp.photo_url 
                              : 'https://via.placeholder.com/150';
                }
            };
            check();
            supabase.channel('worker-listen').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'jobs', filter: `worker_id=eq.${state.user.id}` }, check).subscribe();
        }

        function acceptJob() {
            document.getElementById('worker-otp-section').classList.remove('hidden');
            document.getElementById('start-job-btn-container').classList.add('hidden');
        }

        async function verifyOtp() {
            if (document.getElementById('job-otp-input').value === state.activeJob.otp) {
                await supabase.from('jobs').update({ status: 'completed' }).eq('id', state.activeJob.id);
                alert("Job Completed!");
                location.reload();
            } else {
                alert("Incorrect OTP");
            }
        }
    </script>
</body>
</html>
