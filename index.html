<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rozgaar Saathi | Find Work & Workers</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Remix Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- SDKs -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #4E3BF7;      
            --primary-dark: #3a2bc2;
            --bg: #F3F4F6;           
            --surface: #ffffff;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --success: #10B981;
            --danger: #EF4444;
            --radius: 16px;
            --ease-spring: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Manrope', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.6;
            overscroll-behavior-y: none;
        }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            height: 70px;
            transition: all 0.3s var(--ease-spring);
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.5px;
        }
        .brand span { color: var(--primary); }

        #logoutBtn {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s var(--ease-spring);
        }
        #logoutBtn:hover { background: #f3f4f6; color: var(--text-main); transform: translateY(-1px); }

        /* --- MAIN CONTAINER --- */
        main {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            min-height: calc(100vh - 70px);
            padding-bottom: 120px;
        }

        /* --- ANIMATIONS --- */
        .view { 
            animation: slideFadeIn 0.6s var(--ease-spring) forwards;
            will-change: transform, opacity;
        }
        
        @keyframes slideFadeIn {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .hidden { display: none !important; }

        h2 { font-size: 1.75rem; font-weight: 800; margin: 0 0 0.5rem 0; letter-spacing: -0.5px; color: #111827; }
        h2 + p { color: var(--text-muted); margin-top: 0; margin-bottom: 2rem; font-size: 1.05rem; }

        /* --- FORMS & INPUTS --- */
        .form-group { margin-bottom: 1.2rem; position: relative; }
        
        input, select {
            width: 100%;
            padding: 18px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-main);
            transition: all 0.2s var(--ease-spring);
            -webkit-appearance: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(78, 59, 247, 0.1);
            transform: translateY(-1px);
        }

        /* --- SKELETON LOADING --- */
        .skeleton-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .skeleton-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .skeleton {
            background: #e0e0e0;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        .sk-circle { width: 60px; height: 60px; border-radius: 50%; flex-shrink: 0; }
        .sk-line { height: 16px; width: 100%; margin-bottom: 8px; }
        .sk-line.short { width: 60%; }
        .sk-btn { width: 80px; height: 40px; margin-left: auto; border-radius: 8px; }

        @keyframes shimmer { 
            0% { background-position: 200% 0; } 
            100% { background-position: -200% 0; } 
        }

        /* --- BUTTONS --- */
        button.primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s var(--ease-spring);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 20px -5px rgba(78, 59, 247, 0.3);
        }
        button.primary-btn:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 15px 25px -5px rgba(78, 59, 247, 0.4); }
        button.primary-btn:active { transform: scale(0.98); }

        .spinner-icon { animation: spin 0.8s linear infinite; font-size: 1.3rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- MIC BUTTON --- */
        .mic-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: 0 8px 30px rgba(78, 59, 247, 0.4);
            font-size: 1.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s var(--ease-spring);
        }
        .mic-btn:hover { transform: scale(1.05) rotate(5deg); }
        .mic-listening { background: var(--danger); animation: pulse 1.5s infinite; box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- CARDS --- */
        .card-container { display: grid; gap: 1rem; margin-top: 1.5rem; }
        .role-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s var(--ease-spring);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }
        .role-card:hover { 
            border-color: var(--primary); 
            background: #F5F3FF; 
            transform: translateY(-4px); 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05); 
        }
        .role-card i { font-size: 2.8rem; color: #9CA3AF; margin-bottom: 15px; display: block; transition: 0.3s; }
        .role-card:hover i { color: var(--primary); transform: scale(1.1); }
        
        .worker-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 1.2rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s var(--ease-spring);
            animation: fadeInItem 0.5s var(--ease-spring) backwards;
        }
        .worker-card:nth-child(1) { animation-delay: 0.1s; }
        .worker-card:nth-child(2) { animation-delay: 0.2s; }
        .worker-card:nth-child(3) { animation-delay: 0.3s; }

        @keyframes fadeInItem {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .worker-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background: #f3f4f6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .active-job-profile {
            background: #F0FDFA; 
            border: 1px solid var(--success);
            align-items: flex-start;
        }
        
        /* --- TOAST --- */
        #toast-container {
            position: fixed;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
            pointer-events: none;
        }
        .toast {
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(8px);
            color: white;
            padding: 14px 20px;
            border-radius: 50px;
            margin-top: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            animation: slideUp 0.4s var(--ease-spring) forwards;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .toast.success { background: #064E3B; color: #D1FAE5; }
        .toast.error { background: #7F1D1D; color: #FEE2E2; }
        @keyframes slideUp { from { opacity:0; transform:translateY(30px) scale(0.9); } to { opacity:1; transform:translateY(0) scale(1); } }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            main { padding: 1.5rem 1rem; }
            h2 { font-size: 1.6rem; }
            .worker-card { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <header>
        <div class="brand">
            <i class="ri-briefcase-4-fill" style="color:var(--primary); font-size:1.6rem;"></i>
            Rozgaar<span>Saathi</span>
        </div>
        <button id="logoutBtn" class="hidden" onclick="handleLogout()">
            <i class="ri-logout-box-r-line"></i> <span>Logout</span>
        </button>
    </header>

    <button id="mic-btn" class="mic-btn hidden" onclick="toggleVoice()">
        <i class="ri-mic-fill"></i>
    </button>
    
    <!-- Audio element for voice response -->
    <audio id="response-audio" src="response.mp3" preload="auto"></audio>

    <main id="app">
        
        <!-- SCREEN 1: Role Selection -->
        <section id="role-selection" class="view">
            <h2 data-i18n="who_are_you">Who are you?</h2>
            <p data-i18n="select_role">Select your role to get started.</p>
            <div class="card-container">
                <div onclick="selectRole('employer')" class="role-card">
                    <i class="ri-building-4-line"></i>
                    <h3 data-i18n="employer">Employer</h3>
                    <span style="color:var(--text-muted)" data-i18n="hire_workers">I want to hire workers</span>
                </div>
                <div onclick="selectRole('worker')" class="role-card">
                    <i class="ri-hammer-line"></i>
                    <h3 data-i18n="worker">Worker</h3>
                    <span style="color:var(--text-muted)" data-i18n="looking_jobs">I am looking for jobs</span>
                </div>
            </div>
        </section>

        <!-- SCREEN 1.5: Language -->
        <section id="language-selection" class="view hidden">
            <h2>Select Language</h2>
            <p>Choose your preferred language.</p>
            <div class="card-container">
                <button class="primary-btn" style="background:white; color:var(--text-main); border:1px solid var(--border); justify-content:space-between" onclick="setLanguage('en')">English <i class="ri-arrow-right-s-line"></i></button>
                <button class="primary-btn" style="background:white; color:var(--text-main); border:1px solid var(--border); justify-content:space-between" onclick="setLanguage('hi')">Hindi (हिंदी) <i class="ri-arrow-right-s-line"></i></button>
                <button class="primary-btn" style="background:white; color:var(--text-main); border:1px solid var(--border); justify-content:space-between" onclick="setLanguage('pb')">Punjabi (ਪੰਜਾਬੀ) <i class="ri-arrow-right-s-line"></i></button>
            </div>
        </section>

        <!-- SCREEN 2: Auth -->
        <section id="auth-screen" class="view hidden">
            <h2 id="auth-title" data-i18n="welcome_back">Welcome Back</h2>
            <p id="auth-subtitle" data-i18n="enter_details">Enter your details to login.</p>
            
            <form id="auth-form">
                <div class="form-group">
                    <input type="email" id="email" placeholder="Email Address" autocomplete="email" required>
                </div>
                <div class="form-group">
                    <div style="position:relative">
                        <input type="password" id="password" placeholder="Password" autocomplete="current-password" required>
                        <i class="ri-eye-off-line" id="eye-icon" onclick="togglePasswordVisibility()" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#9CA3AF; cursor:pointer; font-size:1.2rem;"></i>
                    </div>
                </div>
                
                <button type="submit" class="primary-btn" id="auth-btn">
                    <span data-i18n="login_btn">Login</span> <i class="ri-arrow-right-line"></i>
                </button>

                <div class="auth-toggle">
                    <p id="toggle-text"><span data-i18n="new_here">New here?</span> <span onclick="toggleAuthMode()" data-i18n="create_account">Create an Account</span></p>
                </div>
            </form>
        </section>

        <!-- SCREEN 2.5: Verify Email -->
        <section id="verify-email-screen" class="view hidden" style="text-align:center; padding-top:2rem;">
            <div style="background:#EFF6FF; width:100px; height:100px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem auto; box-shadow:0 10px 30px -10px rgba(78, 59, 247, 0.2);">
                <i class="ri-mail-send-line" style="font-size:3rem; color:var(--primary);"></i>
            </div>
            <h2 data-i18n="check_inbox">Check your Inbox</h2>
            <p><span data-i18n="email_sent">We have sent a verification link to</span> <br><strong id="sent-email" style="color:var(--text-main)"></strong></p>
            <div class="spinner-icon" style="color:var(--primary); font-size:2rem; margin:2rem 0;"><i class="ri-loader-4-line"></i></div>
            <button class="primary-btn" style="background:transparent; color:var(--text-muted); border:1px solid var(--border);" onclick="location.reload()" data-i18n="verified_btn">I have verified</button>
        </section>

        <!-- SCREEN 3: Profile Setup -->
        <section id="onboarding-screen" class="view hidden">
            <h2 data-i18n="complete_profile">Complete Profile</h2>
            <p data-i18n="few_details">Just a few more details.</p>
            <form id="profile-form">
                <div class="form-group" style="text-align:center; margin-bottom:2rem;">
                    <label for="profile-photo" style="display:inline-block; position:relative; cursor:pointer;">
                        <div style="width:100px; height:100px; background:#F3F4F6; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px dashed var(--border);">
                            <i class="ri-camera-fill" style="font-size:2rem; color:var(--text-muted);"></i>
                        </div>
                        <input type="file" id="profile-photo" accept="image/*" style="display:none" required onchange="this.previousElementSibling.style.borderColor='var(--success)'">
                        <span style="font-size:0.85rem; color:var(--primary); display:block; margin-top:5px;" data-i18n="upload_photo">Upload Photo</span>
                    </label>
                </div>
                
                <div id="worker-category-input" class="hidden form-group">
                    <select id="category" required>
                        <option value="" disabled selected>Select Category</option>
                        <option value="Labour">Labour Worker</option>
                        <option value="Carpenter">Carpenter</option>
                        <option value="Maid">Maid</option>
                        <option value="Cook">Cook</option>
                        <option value="Cleaner">Home Cleaner</option>
                        <option value="Electrician">Electrician</option>
                        <option value="Plumber">Plumber</option>
                    </select>
                </div>

                <div class="form-group"><input type="text" id="full-name" placeholder="Full Name" autocomplete="name" required></div>
                <div class="form-group"><input type="tel" id="phone" placeholder="Mobile Number" autocomplete="tel" required></div>
                
                <div class="form-group">
                    <select id="city" required>
                        <option value="" disabled selected>Select City</option>
                        <option value="New Delhi">New Delhi</option>
                        <option value="Ludhiana">Ludhiana</option>
                        <option value="Gurgaon">Gurgaon</option>
                        <option value="Mumbai">Mumbai</option>
                    </select>
                </div>
                <div class="form-group"><input type="text" id="address" placeholder="Full Address" autocomplete="street-address" required></div>
                
                <button type="submit" class="primary-btn" data-i18n="save_profile">Save Profile</button>
            </form>
        </section>

        <!-- SCREEN 4: Employer Dashboard -->
        <section id="employer-dashboard" class="view hidden">
            <h2 data-i18n="find_workers">Find Workers</h2>
            <div style="background:white; padding:10px; border:1px solid var(--border); border-radius:16px; display:flex; gap:10px; margin-bottom:1.5rem; box-shadow:0 4px 20px -5px rgba(0,0,0,0.05);">
                <select id="search-category" style="border:none; background:transparent; padding:12px; font-weight:600; box-shadow:none;">
                    <option value="Labour">Labour Worker</option>
                    <option value="Carpenter">Carpenter</option>
                    <option value="Maid">Maid</option>
                    <option value="Cook">Cook</option>
                    <option value="Cleaner">Cleaner</option>
                    <option value="Electrician">Electrician</option>
                    <option value="Plumber">Plumber</option>
                </select>
                <button class="primary-btn" style="width:auto; padding:0 1.5rem; border-radius:12px;" onclick="findWorkers()">
                    <i class="ri-search-line"></i>
                </button>
            </div>
            
            <!-- Skeleton Loader (Hidden by default) -->
            <div id="workers-skeleton" class="skeleton-wrapper hidden">
                <div class="skeleton-card">
                    <div class="skeleton sk-circle"></div>
                    <div style="flex:1">
                        <div class="skeleton sk-line"></div>
                        <div class="skeleton sk-line short"></div>
                    </div>
                    <div class="skeleton sk-btn"></div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton sk-circle"></div>
                    <div style="flex:1">
                        <div class="skeleton sk-line"></div>
                        <div class="skeleton sk-line short"></div>
                    </div>
                    <div class="skeleton sk-btn"></div>
                </div>
            </div>

            <div id="workers-list"></div>
        </section>

        <!-- SCREEN 5: Worker Dashboard -->
        <section id="worker-dashboard" class="view hidden">
            <h2 data-i18n="dashboard">My Dashboard</h2>
            
            <div id="worker-waiting-card" class="role-card" style="cursor:default; margin-top:2rem;">
                <span style="background:#FFF7ED; color:#C2410C; padding:8px 16px; border-radius:20px; font-size:0.8rem; font-weight:700;" data-i18n="waiting">WAITING</span>
                <p style="margin:20px 0; font-weight:600;" data-i18n="looking_for_jobs">Looking for jobs nearby...</p>
                <div class="spinner-icon" style="color:var(--primary); font-size:1.5rem;"><i class="ri-loader-4-line"></i></div>
            </div>

            <div id="worker-active-job-card" class="hidden">
                <div class="toast success" style="margin:0 0 1.5rem 0; width:100%; justify-content:center; position:relative; bottom:auto; left:auto; transform:none; animation:none; max-width:100%;">
                    <i class="ri-checkbox-circle-fill"></i> <span data-i18n="hired_msg">You have been hired!</span>
                </div>
                
                <div class="worker-card active-job-profile">
                    <img id="employer-photo" src="" alt="Emp">
                    <div style="flex:1">
                        <h3 id="employer-name" style="margin:0 0 5px 0;"></h3>
                        <p style="margin:0; font-size:0.9rem; color:var(--text-muted);">
                            <i class="ri-map-pin-fill" style="color:var(--primary);"></i> <span id="employer-address"></span>
                        </p>
                        <a id="employer-phone" href="#" class="primary-btn" style="margin-top:15px; background:var(--success); width:fit-content; padding:10px 20px; font-size:0.9rem;">
                           <i class="ri-phone-fill"></i> Call Now
                        </a>
                    </div>
                </div>

                <div id="otp-entry-area" style="margin-top:2rem;">
                    <button class="primary-btn" onclick="showOtpInput(this)" data-i18n="start_job">I have arrived / Start Job</button>
                </div>
                
                <div id="worker-otp-form" class="hidden" style="margin-top:1.5rem; background:white; padding:1.5rem; border-radius:16px; border:1px solid var(--border); box-shadow:0 10px 30px -10px rgba(0,0,0,0.1);">
                    <h3 style="margin:0 0 1rem 0; font-size:1.1rem; text-align:center;" data-i18n="enter_otp">Enter OTP from Employer</h3>
                    <input type="number" id="job-otp-input" placeholder="000000" style="font-size:2rem; letter-spacing:8px; text-align:center; margin-bottom:1.5rem; font-weight:700; color:var(--primary); border:2px dashed var(--border);">
                    <button class="primary-btn" onclick="verifyOtp()" data-i18n="verify">Verify & Complete</button>
                </div>
            </div>
        </section>

        <!-- SCREEN 6: Job In Progress (Employer) -->
        <section id="employer-job-screen" class="view hidden">
            <h2 data-i18n="job_active">Job Active</h2>
            <p data-i18n="worker_on_way">Worker is on the way.</p>

            <div class="worker-card active-job-profile">
                <img id="job-worker-photo" src="" alt="Wkr">
                <div style="flex:1">
                    <h3 id="job-worker-name" style="margin:0;"></h3>
                    <p style="color:var(--success); font-size:0.9rem; font-weight:700; margin:4px 0;">• Hired</p>
                    <a id="job-worker-phone" href="#" class="primary-btn" style="background:var(--success); width:fit-content; padding:8px 16px; margin-top:10px; font-size:0.85rem;"><i class="ri-phone-fill"></i> Call</a>
                </div>
            </div>
            
            <div style="background:white; border:2px dashed #FB923C; border-radius:16px; padding:2rem 1rem; text-align:center; margin-top:2rem; box-shadow:0 10px 30px -5px rgba(251, 146, 60, 0.15);">
                <p style="margin:0; color:#9A3412; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;" data-i18n="share_otp">Share OTP when work is done</p>
                <div id="generated-otp" style="font-size:3rem; font-weight:800; color:#C2410C; margin:15px 0; letter-spacing:6px; font-family:monospace;">------</div>
            </div>

            <div id="employer-completion-msg" class="hidden" style="margin-top:2rem; text-align:center;">
                <div class="toast success" style="width:100%; justify-content:center; margin-bottom:1.5rem; position:relative; bottom:auto; left:auto; transform:none; animation:none; max-width:100%;">
                    <i class="ri-check-double-line"></i> <span data-i18n="work_completed">Work Completed!</span>
                </div>
                <button class="primary-btn" onclick="location.reload()" data-i18n="find_another">Find Another Worker</button>
            </div>
        </section>

    </main>

    <!-- LOGIC -->
    <script>
        // --- TRANSLATIONS ---
        const dictionary = {
            en: {
                who_are_you: "Who are you?",
                select_role: "Select your role to get started.",
                employer: "Employer",
                worker: "Worker",
                hire_workers: "I want to hire workers",
                looking_jobs: "I am looking for jobs",
                welcome_back: "Welcome Back",
                enter_details: "Enter your details to login.",
                login_btn: "Login",
                new_here: "New here?",
                create_account: "Create an Account",
                check_inbox: "Check your Inbox",
                email_sent: "We have sent a verification link to",
                verified_btn: "I have verified",
                complete_profile: "Complete Profile",
                few_details: "Just a few more details.",
                upload_photo: "Upload Photo",
                save_profile: "Save Profile",
                find_workers: "Find Workers",
                dashboard: "My Dashboard",
                waiting: "WAITING",
                looking_for_jobs: "Looking for jobs nearby...",
                hired_msg: "You have been hired!",
                start_job: "I have arrived / Start Job",
                enter_otp: "Enter OTP from Employer",
                verify: "Verify & Complete",
                job_active: "Job Active",
                worker_on_way: "Worker is on the way.",
                share_otp: "Share OTP after work is done",
                work_completed: "Work Completed!",
                find_another: "Find Another Worker"
            },
            hi: {
                who_are_you: "आप कौन हैं?",
                select_role: "शुरू करने के लिए अपनी भूमिका चुनें।",
                employer: "नियोक्ता (Employer)",
                worker: "कामगार (Worker)",
                hire_workers: "मुझे काम के लिए लोग चाहिए",
                looking_jobs: "मैं काम ढूंढ रहा हूँ",
                welcome_back: "वापसी पर स्वागत है",
                enter_details: "लॉगिन करने के लिए विवरण दर्ज करें।",
                login_btn: "लॉगिन करें",
                new_here: "नए हैं?",
                create_account: "खाता बनाएं",
                check_inbox: "अपना इनबॉक्स चेक करें",
                email_sent: "हमने सत्यापन लिंक भेजा है",
                verified_btn: "मैंने सत्यापित कर लिया है",
                complete_profile: "प्रोफ़ाइल पूरी करें",
                few_details: "बस कुछ और जानकारी।",
                upload_photo: "फोटो अपलोड करें",
                save_profile: "प्रोफ़ाइल सहेजें",
                find_workers: "कामगार ढूंढें",
                dashboard: "मेरा डैशबोर्ड",
                waiting: "प्रतीक्षा",
                looking_for_jobs: "आसपास काम ढूंढ रहे हैं...",
                hired_msg: "आपको काम मिल गया है!",
                start_job: "मैं पहुँच गया / काम शुरू करें",
                enter_otp: "मालिक से OTP दर्ज करें",
                verify: "सत्यापित करें और पूरा करें",
                job_active: "काम चालू है",
                worker_on_way: "कामगार रास्ते में है।",
                share_otp: "काम पूरा होने पर OTP साझा करें",
                work_completed: "काम पूरा हुआ!",
                find_another: "दूसरा कामगार ढूंढें"
            },
            pb: {
                who_are_you: "ਤੁਸੀਂ ਕੌਣ ਹੋ?",
                select_role: "ਸ਼ੁਰੂ ਕਰਨ ਲਈ ਆਪਣੀ ਭੂਮਿਕਾ ਚੁਣੋ।",
                employer: "ਮਾਲਕ (Employer)",
                worker: "ਕਾਮਾ (Worker)",
                hire_workers: "ਮੈਨੂੰ ਕਾਮੇ ਚਾਹੀਦੇ ਹਨ",
                looking_jobs: "ਮੈਂ ਕੰਮ ਲੱਭ ਰਿਹਾ ਹਾਂ",
                welcome_back: "ਜੀ ਆਇਆਂ ਨੂੰ",
                enter_details: "ਲਾਗਇਨ ਕਰਨ ਲਈ ਵੇਰਵੇ ਭਰੋ।",
                login_btn: "ਲਾਗਇਨ",
                new_here: "ਨਵੇਂ ਹੋ?",
                create_account: "ਖਾਤਾ ਬਣਾਓ",
                check_inbox: "ਆਪਣਾ ਇਨਬਾਕਸ ਚੈੱਕ ਕਰੋ",
                email_sent: "ਅਸੀਂ ਲਿੰਕ ਭੇਜ ਦਿੱਤਾ ਹੈ",
                verified_btn: "ਮੈਂ ਤਸਦੀਕ ਕਰ ਲਿਆ ਹੈ",
                complete_profile: "ਪ੍ਰੋਫਾਈਲ ਪੂਰਾ ਕਰੋ",
                few_details: "ਬਸ ਕੁਝ ਹੋਰ ਜਾਣਕਾਰੀ।",
                upload_photo: "ਫੋਟੋ ਅਪਲੋਡ ਕਰੋ",
                save_profile: "ਸੇਵ ਕਰੋ",
                find_workers: "ਕਾਮੇ ਲੱਭੋ",
                dashboard: "ਮੇਰਾ ਡੈਸ਼ਬੋਰਡ",
                waiting: "ਉਡੀਕ",
                looking_for_jobs: "ਨੇੜੇ ਕੰਮ ਲੱਭ ਰਹੇ ਹਾਂ...",
                hired_msg: "ਤੁਹਾਨੂੰ ਕੰਮ ਮਿਲ ਗਿਆ ਹੈ!",
                start_job: "ਮੈਂ ਪਹੁੰਚ ਗਿਆ / ਕੰਮ ਸ਼ੁਰੂ ਕਰੋ",
                enter_otp: "ਮਾਲਕ ਤੋਂ OTP ਭਰੋ",
                verify: "ਪੂਰਾ ਕਰੋ",
                job_active: "ਕੰਮ ਚੱਲ ਰਿਹਾ ਹੈ",
                worker_on_way: "ਕਾਮਾ ਰਸਤੇ ਵਿੱਚ ਹੈ।",
                share_otp: "ਕੰਮ ਹੋਣ 'ਤੇ OTP ਦਿਓ",
                work_completed: "ਕੰਮ ਪੂਰਾ ਹੋ ਗਿਆ!",
                find_another: "ਹੋਰ ਕਾਮਾ ਲੱਭੋ"
            }
        };

        // --- SETUP ---
        const SUPABASE_URL = 'https://prjwnbctmwkrscdsmtkh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByanduYmN0bXdrcnNjZHNtdGtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MjkwMDksImV4cCI6MjA3OTIwNTAwOX0.28WSuMkPd76qUSjGMz5KkKx-8cGtx17-0PgLYj8DfGM';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = {
            user: null,
            profile: null,
            role: localStorage.getItem('rozgaar_role'), 
            lang: localStorage.getItem('rozgaar_lang') || 'en',
            activeJob: null,
            searchResult: [],
            isLoginMode: true 
        };

        // --- UI HELPERS ---
        function updateTranslations() {
            const t = dictionary[state.lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    if (el.tagName === 'INPUT') el.placeholder = t[key];
                    else el.textContent = t[key];
                }
            });
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<i class="ri-${type === 'success' ? 'checkbox-circle' : 'error-warning'}-fill"></i> ${msg}`;
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                setTimeout(() => el.remove(), 400);
            }, 3000);
        }

        function setLoading(btn, isLoading, text = null) {
            if (isLoading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner-icon"><i class="ri-loader-4-line"></i></div>`;
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText;
            }
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('password');
            const icon = document.getElementById('eye-icon');
            if (input.type === "password") {
                input.type = "text";
                icon.className = "ri-eye-line";
            } else {
                input.type = "password";
                icon.className = "ri-eye-off-line";
            }
        }

        // --- APP FLOW ---
        window.onload = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            updateTranslations();
            if (session) handleSession(session.user);
            else {
                localStorage.removeItem('rozgaar_role');
                showView('role-selection');
            }
        };

        function showView(id) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            const newView = document.getElementById(id);
            newView.classList.remove('hidden');
            
            // Re-trigger animation
            newView.style.animation = 'none';
            newView.offsetHeight; /* trigger reflow */
            newView.style.animation = null; 

            const hideLogout = ['role-selection','auth-screen','language-selection', 'verify-email-screen'];
            document.getElementById('logoutBtn').classList.toggle('hidden', hideLogout.includes(id));
            
            // Show mic button if logged in
            if(id === 'employer-dashboard' || id === 'worker-dashboard' || id === 'employer-job-screen') {
                document.getElementById('mic-btn').classList.remove('hidden');
            } else {
                document.getElementById('mic-btn').classList.add('hidden');
            }
        }

        // --- ROLE & LANG ---
        async function selectRole(role) {
            state.role = role;
            localStorage.setItem('rozgaar_role', role);
            if (state.user) {
                const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', state.user.id).single();
                if(profile && profile.role !== role) {
                     alert(`Wrong account. Please login as ${profile.role}.`);
                     location.reload();
                     return;
                }
                location.reload();
            } else {
                showView('language-selection');
            }
        }

        function setLanguage(l) {
            state.lang = l;
            localStorage.setItem('rozgaar_lang', l);
            updateTranslations();
            showView('auth-screen');
        }

        // --- AUTH LOGIC ---
        function toggleAuthMode() {
            state.isLoginMode = !state.isLoginMode;
            const title = document.getElementById('auth-title');
            const sub = document.getElementById('auth-subtitle');
            const btn = document.querySelector('#auth-btn span');
            const toggle = document.querySelector('#toggle-text');
            const t = dictionary[state.lang];

            if (state.isLoginMode) {
                title.textContent = t.welcome_back;
                sub.textContent = t.enter_details;
                btn.textContent = t.login_btn;
                toggle.innerHTML = `${t.new_here} <span onclick="toggleAuthMode()">${t.create_account}</span>`;
                document.getElementById('password').autocomplete = "current-password";
            } else {
                title.textContent = t.create_account;
                sub.textContent = t.enter_details;
                btn.textContent = t.create_account;
                toggle.innerHTML = `Member? <span onclick="toggleAuthMode()">${t.login_btn}</span>`;
                document.getElementById('password').autocomplete = "new-password";
            }
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if(!email || !password) return;

            const btn = document.getElementById('auth-btn');
            setLoading(btn, true);

            try {
                if (state.isLoginMode) {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    handleSession(data.user);
                } else {
                    const { data, error } = await supabaseClient.auth.signUp({
                        email, 
                        password,
                        options: { emailRedirectTo: 'https://rozgaar.codeinblack.tech/' }
                    });
                    if (error) throw error;
                    document.getElementById('sent-email').textContent = email;
                    showView('verify-email-screen');
                    setLoading(btn, false);
                }
            } catch (err) {
                showToast(err.message, 'error');
                setLoading(btn, false);
            }
        });

        // --- MAIN LOGIC ---
        async function handleSession(user) {
            state.user = user;
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();

            if (profile) {
                state.lang = profile.language || 'en';
                updateTranslations();
                state.profile = profile;
                state.role = profile.role;
                localStorage.setItem('rozgaar_role', profile.role);

                if (state.role === 'employer') {
                    showView('employer-dashboard');
                    checkActiveJobsEmployer();
                } else {
                    showView('worker-dashboard');
                    listenForJobs();
                }
            } else {
                showView('onboarding-screen');
                if(state.role === 'employer') {
                    document.getElementById('worker-category-input').classList.add('hidden');
                    document.getElementById('category').removeAttribute('required');
                } else {
                    document.getElementById('worker-category-input').classList.remove('hidden');
                    document.getElementById('category').setAttribute('required', 'true');
                }
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            localStorage.clear();
            location.reload();
        }

        // --- PROFILE SAVE ---
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            setLoading(btn, true);

            const file = document.getElementById('profile-photo').files[0];
            let publicUrl = "https://via.placeholder.com/150";

            try {
                if (file) {
                    const fileName = `${Date.now()}-${file.name}`;
                    await supabaseClient.storage.from('avatars').upload(fileName, file);
                    const res = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
                    publicUrl = res.data.publicUrl;
                }

                const role = state.role || localStorage.getItem('rozgaar_role');
                const payload = {
                    id: state.user.id,
                    role: role,
                    full_name: document.getElementById('full-name').value,
                    phone: document.getElementById('phone').value,
                    city: document.getElementById('city').value,
                    address: document.getElementById('address').value,
                    photo_url: publicUrl,
                    category: role === 'worker' ? document.getElementById('category').value : null,
                    language: state.lang
                };

                const { error } = await supabaseClient.from('profiles').insert(payload);
                if (error) throw error;
                location.reload();
            } catch(err) {
                showToast(err.message, 'error');
                setLoading(btn, false);
            }
        });

        // --- EMPLOYER FEATURES ---
        async function findWorkers() {
            return new Promise(async (resolve) => {
                const cat = document.getElementById('search-category').value;
                const btn = document.querySelector('#employer-dashboard button');
                const list = document.getElementById('workers-list');
                const skeleton = document.getElementById('workers-skeleton');

                // UI State: Loading
                list.innerHTML = '';
                skeleton.classList.remove('hidden');
                btn.disabled = true;

                // Simulate smoother network feel
                await new Promise(r => setTimeout(r, 800));

                const { data } = await supabaseClient.from('profiles').select('*').eq('role', 'worker').eq('category', cat);
                state.searchResult = data || [];
                
                // UI State: Done
                skeleton.classList.add('hidden');
                btn.disabled = false;

                if (!data || !data.length) {
                    list.innerHTML = `<div style="text-align:center; margin-top:2rem; color:var(--text-muted); animation:fadeInItem 0.5s ease"><i class="ri-ghost-smile-line" style="font-size:2rem"></i><p>No workers found nearby.</p></div>`;
                    resolve(false);
                    return;
                }

                data.forEach(w => {
                    const img = (w.photo_url && !w.photo_url.includes('placeholder')) ? w.photo_url : 'https://via.placeholder.com/150';
                    list.innerHTML += `
                        <div class="worker-card">
                            <img src="${img}">
                            <div style="flex:1">
                                <h3 style="margin:0; font-size:1.1rem; font-weight:700;">${w.full_name}</h3>
                                <p style="margin:0; font-size:0.9rem; color:var(--text-muted);"><i class="ri-map-pin-line"></i> ${w.city}</p>
                            </div>
                            <button class="primary-btn hire-btn" style="width:auto; padding:10px 20px; font-size:0.9rem;" data-id="${w.id}" onclick="initiateHire('${w.id}')">Hire ₹60</button>
                        </div>
                    `;
                });
                resolve(true);
            });
        }

        async function initiateHire(wid) {
            const worker = state.searchResult.find(w => w.id === wid);
            showToast("Processing Payment...", "success");

            try {
                const res = await fetch("https://razorpay-snll.onrender.com/create-order", { method: "POST", headers: {"Content-Type":"application/json"} });
                if (!res.ok) throw new Error("Payment server offline");
                const order = await res.json();

                const options = {
                    "key": "rzp_live_Rh4kTjb6HHV09d", 
                    "amount": order.amount, 
                    "currency": order.currency,
                    "name": "Rozgaar Saathi",
                    "description": "Hiring " + worker.full_name,
                    "order_id": order.id,
                    "handler": function (response) { createJob(worker); },
                    "prefill": { "name": state.profile.full_name, "contact": state.profile.phone },
                    "theme": { "color": "#4E3BF7" }
                };
                new Razorpay(options).open();
            } catch(err) {
                showToast(err.message, 'error');
            }
        }

        async function createJob(worker) {
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            await supabaseClient.from('jobs').insert({ employer_id: state.user.id, worker_id: worker.id, otp: otp, status: 'hired' });
            showJobScreen(otp, worker);
        }

        function showJobScreen(otp, worker) {
            showView('employer-job-screen');
            document.getElementById('generated-otp').textContent = otp;
            document.getElementById('job-worker-name').textContent = worker.full_name;
            
            const link = document.getElementById('job-worker-phone');
            link.href = `tel:${worker.phone}`;
            
            const img = document.getElementById('job-worker-photo');
            img.src = (worker.photo_url && !worker.photo_url.includes('placeholder')) ? worker.photo_url : 'https://via.placeholder.com/150';

            const channel = supabaseClient.channel('job-track').on('postgres_changes', 
                { event: 'UPDATE', schema: 'public', table: 'jobs', filter: `employer_id=eq.${state.user.id}` }, 
                (payload) => {
                    if (payload.new.status === 'completed') {
                        document.getElementById('employer-completion-msg').classList.remove('hidden');
                        supabaseClient.removeChannel(channel);
                    }
                }
            ).subscribe();
        }

        async function checkActiveJobsEmployer() {
            const { data } = await supabaseClient.from('jobs').select('*, profiles:worker_id(*)').eq('employer_id', state.user.id).eq('status', 'hired').single();
            if(data) showJobScreen(data.otp, data.profiles);
        }

        // --- WORKER FEATURES ---
        async function listenForJobs() {
            const check = async () => {
                const { data } = await supabaseClient.from('jobs').select('*, profiles:employer_id(*)').eq('worker_id', state.user.id).eq('status', 'hired').single();
                if (data) {
                    state.activeJob = data;
                    const emp = data.profiles;
                    
                    document.getElementById('worker-waiting-card').classList.add('hidden');
                    document.getElementById('worker-active-job-card').classList.remove('hidden');

                    document.getElementById('employer-name').textContent = emp.full_name;
                    document.getElementById('employer-address').textContent = emp.address;
                    
                    const link = document.getElementById('employer-phone');
                    link.href = `tel:${emp.phone}`;

                    const img = document.getElementById('employer-photo');
                    img.src = (emp.photo_url && !emp.photo_url.includes('placeholder')) ? emp.photo_url : 'https://via.placeholder.com/150';
                }
            };
            check();
            supabaseClient.channel('worker-listen').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'jobs', filter: `worker_id=eq.${state.user.id}` }, check).subscribe();
        }

        function showOtpInput(btn) {
            btn.classList.add('hidden');
            document.getElementById('worker-otp-form').classList.remove('hidden');
        }

        async function verifyOtp() {
            const input = document.getElementById('job-otp-input');
            const btn = document.querySelector('#worker-otp-form button');
            setLoading(btn, true);

            if (input.value == state.activeJob.otp) {
                await supabaseClient.from('jobs').update({ status: 'completed' }).eq('id', state.activeJob.id);
                showToast("Job Completed!", 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast("Incorrect OTP", 'error');
                setLoading(btn, false);
            }
        }

        // --- VOICE RECOGNITION FEATURE ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = () => {
                document.getElementById('mic-btn').classList.add('mic-listening');
            };

            recognition.onend = () => {
                document.getElementById('mic-btn').classList.remove('mic-listening');
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                console.log("Voice Command:", transcript);

                try {
                    const audio = document.getElementById('response-audio');
                    await audio.play().catch(e => {});
                } catch(e) {}

                // COMMAND: HIRE [CATEGORY]
                if (transcript.includes('hire') && state.role === 'employer') {
                    // 1. Identify valid category from dropdown options
                    const select = document.getElementById('search-category');
                    let foundValue = null;

                    // Loop through actual options to match transcript (case-insensitive)
                    for (let i = 0; i < select.options.length; i++) {
                        const opt = select.options[i];
                        if (transcript.includes(opt.value.toLowerCase())) {
                            foundValue = opt.value;
                            break;
                        }
                    }
                    
                    if (foundValue) {
                        select.value = foundValue; // Update UI
                        showToast(`Voice: Finding ${foundValue}...`);
                        
                        // 2. Wait for search to complete and render HTML
                        const success = await findWorkers();
                        
                        // 3. Wait for DOM paint then click button
                        if (success) {
                            setTimeout(() => {
                                const firstBtn = document.querySelector('.hire-btn');
                                if (firstBtn) {
                                    firstBtn.click();
                                } else {
                                    showToast("No workers found to hire.", 'error');
                                }
                            }, 500); // 500ms delay to ensure button exists
                        }
                    } else {
                        showToast("Category not understood. Try 'Hire Plumber'", 'error');
                    }
                }
                else if (transcript.includes('call employer') && state.role === 'worker') {
                    const link = document.getElementById('employer-phone');
                    if (link && link.href) link.click();
                }
                else if (transcript.includes('call worker') && state.role === 'employer') {
                    const link = document.getElementById('job-worker-phone');
                    if (link && link.href) link.click();
                } 
                else {
                    showToast("Command not recognized", 'error');
                }
            };
        }

        function toggleVoice() {
            if (!recognition) {
                alert("Voice support not available in this browser.");
                return;
            }
            recognition.start();
        }

        // Keep backend alive
        fetch("https://razorpay-snll.onrender.com/create-order");
        setInterval(() => {
          fetch("https://razorpay-snll.onrender.com/create-order");
        }, 180000);

    </script>
</body>
</html>
